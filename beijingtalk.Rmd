---
title: Feature-based Time Series Forecasting
author: Thiyanga S. Talagala
date: "13 March 2019"
toc: false
output:
  binb::monash:
    fig_height: 5
    fig_width: 8
    highlight: tango
    incremental: no
    keep_tex: no
    includes:
      in_header: preamble.tex
colortheme: monashwhite
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE,
  dev.args = list(bg = grey(0.9), pointsize = 11)
)
set.seed(20191103)
options(digits = 3, width = 63)
library(knitr)
read_chunk("src/main.R")
read_chunk("src/corrplot.R")
library(tidyverse)
library(patchwork)
library(png)
library(tsfeatures)
library(RColorBrewer)
library(ggcorrplot) # to draw  ggcorrplot
library(M4comp2018)
library(GGally) # to draw scatterplot matrix
```

## Joint work with

\begin{textblock}{12.5}(0.2,1.2)
\begin{block}{}\fontsize{9}{10}\sf
\centering\begin{tabular}{c c}
\includegraphics[height=3.4cm, width=5cm, keepaspectratio]{rob.jpg} &
\includegraphics[height=3.4cm, width=5cm, keepaspectratio]{george.jpg}\\
Rob J Hyndman & George Athanasopoulos
\end{tabular}

\centering\begin{tabular}{c c c}
\includegraphics[height=3.4cm, width=5cm, keepaspectratio]{pablo.jpg} &
\includegraphics[height=3.4cm, width=5cm, keepaspectratio]{feng.png} &
\includegraphics[height=3.4cm, width=5cm, keepaspectratio]{yanfei.jpg}\\
Pablo Montero-Manso & Feng Li & Yanfei Kang
\end{tabular}
\end{block}
\end{textblock}

## Introduction

  \centerline{\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{figures/mobile.jpg}}

## Time series features

\fontsize{13}{14}\sf

* Transform a given time series $y=\{y_1, y_2, \cdots, y_n\}$ to a feature vector $F = (f_1(y), f_2(y), \cdots, f_p(y))'$}.

\pause


\begincols
\begincol{.48\textwidth}


```{r, warning=FALSE, message=F, echo=FALSE, fig.height=10}
library(Mcomp)
library(ggplot2)
library(grid)
library(gridExtra)
library(ggrepel)
library(png)
library(tsfeatures)
library(tidyverse)
library(ggpubr)

# Extract required series
series_id <- c("N0001", "N0633", "N0625", "N0645","N1912", "N2012")
six_series <- lapply(M3[series_id], function(u){u$x})
p <- lapply(six_series,
function(u) {autoplot(u) + xlab("") + ylab("")}
)
for (i in seq_along(six_series))
p[[i]] <- p[[i]] + ggtitle(series_id[i])+theme(title =element_text(size=30, face='bold'))
grid.arrange(grobs = p, ncol = 2)

```

\endcol 
\begincol{.48\textwidth}

\pause

```{r fig2, fig.height=6.8, fig.width=7, message=F, echo=F, warning=F}
df <- tsfeatures(six_series, c("stl_features")) %>%
  select(trend, seasonal_strength) %>%
  rename(seasonality = seasonal_strength) %>%
  replace_na(list(seasonality = 0))
df$id <- names(six_series)
ggplot(df, aes(x = trend, y = seasonality)) +
  geom_point(size = 5, color = 'red') +
  xlim(0, 1) + ylim(0, 1) +
  coord_fixed() +
  geom_text_repel(
    aes(label = id),
    colour = "black",
    size = 10,
    box.padding = unit(0.5, "lines")
  ) +
  theme(legend.position = "none", text = element_text(size=20))
```

  \endcol
\endcols

## Features used to select a forecasting model

\begin{textblock}{12}(0.1,1.3)\small
\begin{multicols}{2}
  \begin{itemize}\tightlist
    \item length
    \item strength of seasonality
    \item strength of trend
    \item linearity
    \item curvature
    \item spikiness
    \item stability
    \item lumpiness
    \item parameter estimates of Holt's linear trend method
    \item spectral entropy
    \item Hurst exponent
    \item nonlinearity
    \item parameter estimates of Holt-Winters' additive method
    \item unit root test statistics
    \item crossing points, flat spots
    \item peaks, troughs
    \item ACF and PACF based features - calculated on raw, differenced, and remainder series.
    \item ARCH/GARCH statistics and ACF of squared series and residuals.
    \end{itemize}
\end{multicols}
\end{textblock}

## Meta-learning

\centerline{\includegraphics[width=\paperwidth]{figures/metaoffline.png}}


## Meta-learning

\centerline{\includegraphics[width=\paperwidth]{figures/metalearning.png}}

## Feature-based forecasting algorithms

\centerline{\includegraphics[width=\paperwidth]{figures/metahighlight.png}}

## Feature-based forecasting algorithms

\centerline{\includegraphics[width=\paperwidth]{figures/metahighlight.png}}


* \fontsize{8}{8}{three algorithms: \textcolor{blue}{FFORMS}, \textcolor{red}{FFORMA}, FFORMPP}

## \fontsize{15}{15}\bf\sffamily FFORMS: Feature-based FORecast Model Selection

 \centerline{\includegraphics[width=\paperwidth]{figures/fw1.png}}

## FFORMS: observed sample

 \centerline{\includegraphics[width=\paperwidth]{figures/fw2.png}}
 
## FFORMS: simulated time series

 \centerline{\includegraphics[width=\paperwidth]{figures/fw3.png}}
 
## FFORMS: reference set
 
 \centerline{\includegraphics[width=\paperwidth]{figures/fw4.png}}

## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw5.png}}

## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw6.png}}

## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw7.png}}

## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw8.png}}


## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw9.png}}

## FFORMS: Meta-data

\centerline{\includegraphics[width=\paperwidth]{figures/fw10.png}}

## FFORMS: Random-forest classifier

\centerline{\includegraphics[width=\paperwidth]{figures/fw11.png}}


## FFORMS: "online" part of the algorithm

\centerline{\includegraphics[width=\paperwidth]{figures/fw12.png}}


## FFORMS: "online" part of the algorithm

\centerline{\includegraphics[width=\paperwidth]{figures/fw13.png}}

## FFORMS: "online" part of the algorithm

\centerline{\includegraphics[width=\paperwidth]{figures/fw14.png}}

## Application to M competition data

- Proposed algorithm is applied to yearly, quarterly and monthly series separately.

- We run two experiments for each case.

\begin{table}[!htp]
\centering\tiny\tabcolsep=0.2cm
\def\yes{$\checkmark$}
\captionsetup{labelformat=empty}
\label{tbl:Mcomps}
\begin{tabular}{lrrrrr@{\hspace*{0.2cm}}rrrr}
\toprule
                &  \multicolumn{ 4}{c}{Experiment 1} & & \multicolumn{ 4}{c}{Experiment 2} \\
                &    Source  &    Y  & Q  &    M &            &    Source  &    Y  & Q  &    M \\\cline{2-5}\cline{7-10}
& & & & & & & & & \\[-0.1cm]
\colorbox{black}{\color{white}{Observed series}} &         M1 &       181 &        203 &        617 &            &         M3 &        645 &        756 &       1428 \\
\colorbox{ao(english)}{Simulated series} &          &       362000 &        406000 &        123400 &            &          &        1290000 &        1512000&       285600 \\
\colorbox{orange}{New series} &         M3 &    645 &       756 &       1428 &            &         M1 &        181 &        203 &       617 \\
\bottomrule
\end{tabular}
\end{table}

## \fontsize{12}{12}\bf\sffamily Experiment 1: Distribution of time series in the PCA space

\colorbox{black}{\color{white}{observed - M1}} 

  \centerline{\includegraphics[width=\textwidth,height=7.5cm,keepaspectratio]{figures/observed.pdf}}

## \fontsize{12}{12}\bf\sffamily Experiment 1: Distribution of time series in the PCA space

\colorbox{black}{\color{white}{observed - M1}}\colorbox{ao(english)}{simulated}

  \centerline{\includegraphics[width=\textwidth,height=7.5cm,keepaspectratio]{figures/simulated.pdf}}



## \fontsize{12}{12}\bf\sffamily Experiment 1: Distribution of time series in the PCA space

\colorbox{black}{\color{white}{observed - M1}}\colorbox{ao(english)}{simulated}\colorbox{orange}{new - M3}
  \centerline{\includegraphics[width=\textwidth,height=7.5cm,keepaspectratio]{figures/exp1pca-1.pdf}}




## \fontsize{12}{12}\bf\sffamily Experiment 2: Distribution of time series in the PCA space

\colorbox{black}{\color{white}{observed - M3}} \colorbox{ao(english)}{simulated} \colorbox{aureolin}{subset} \colorbox{orange}{new - M1}
  \centerline{\includegraphics[width=\textwidth,height=7.5cm,keepaspectratio]{figures/exp2pca-1.pdf}}

## Results: Yearly

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
method = c("RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "Theta",
           "RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "Theta")
Rank = c(1.50, 1.50, 3.33, 5.00, 8.00, 7.00, 3.67, 6.00,
         3.50, 2.50, 5.83, 4.67, 9.00, 8.00, 1.00, 3.50)
class=c(0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1)
df <- data.frame(method=method, Rank=Rank, class=class)
ggplot(data=df, aes(x=method,y=Rank,fill=factor(class))) +
  geom_bar(position="dodge",stat="identity") + 
  coord_flip() +
   scale_x_discrete(
    limits=c("WN", "RW", "auto.arima", "ets", "Theta", "RWD", "RF-class priors", "RF-unbalanced"),
    labels=c("WN", "RW", "auto.arima", "ets", "Theta", "RWD", "RF-class priors", "RF-unbalanced")
    ) + scale_fill_brewer(breaks=c(1,0), 
    labels=c("Experiment 1 (new: M3)","Experiment 2 (new: M1)")
, palette = "Set1") + 
  theme(axis.title.y=element_blank(), legend.title=element_blank(),
            text = element_text(size=20))
```

## Results: Quarterly


```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
method = c("RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "STL-AR", "Theta", "Snaive",
           "RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "STL-AR", "Theta", "Snaive")
Rank = c(1.00, 2.63, 5.25, 3.00, 10.00, 7.50, 5.38, 8.63, 3.88, 7.75, 2.25,
3.13, 4.75, 3.75, 10.00, 7.00, 6.50, 8.34, 2.50, 6.75)
class=c(0,0,0,0,0,0,0,0,0, 0, 1,1,1,1,1,1,1,1, 1, 1)
df <- data.frame(method=method, Rank=Rank, class=class)
ggplot(data=df, aes(x=method,y=Rank,fill=factor(class))) +
  geom_bar(position="dodge",stat="identity") + 
  coord_flip() +
   scale_x_discrete(
    limits=c("WN","RW",  "RWD","STL-AR", "Snaive", "auto.arima", "ets","Theta", "RF-class priors", "RF-unbalanced"),
    labels=c("WN",  "RW", "RWD","STL-AR", "Snaive", "auto.arima", "ets","Theta", "RF-class priors", "RF-unbalanced")
    ) + scale_fill_brewer(breaks=c(1,0), 
    labels=c("Experiment 1 (new: M3)","Experiment 2 (new: M1)")
, palette = "Set1") + 
  theme(axis.title.y=element_blank(), legend.title=element_blank(),
        text = element_text(size=20))
```

## Results: Monthly


```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(ggplot2)
method = c("RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "STL-AR", "Theta", "Snaive",
           "RF-unbalanced", "RF-class priors", "auto.arima", "ets", "WN", "RW", "RWD", "STL-AR", "Theta", "Snaive")
Rank = c(1.77, 2.83, 4.94, 3.44, 10.00, 7.25, 8.61, 7.38, 2.27, 6.47, 3.22, 2.00, 2.83, 2.72, 10.00, 8.03, 6.89, 7.89, 4.22, 7.19)
class=c(0,0,0,0,0,0,0,0,0, 0, 1,1,1,1,1,1,1,1, 1, 1)
df <- data.frame(method=method, Rank=Rank, class=class)
ggplot(data=df, aes(x=method,y=Rank,fill=factor(class))) +
  geom_bar(position="dodge",stat="identity") + 
  coord_flip() +
   scale_x_discrete(
    limits=c("WN","RW", "RWD","STL-AR",  "Snaive", "auto.arima", "ets","Theta", "RF-class priors", "RF-unbalanced"),
    labels=c("WN","RW", "RWD", "STL-AR",  "Snaive", "auto.arima", "ets","Theta", "RF-class priors", "RF-unbalanced")
    ) + scale_fill_brewer(breaks=c(1,0), 
    labels=c("Experiment 1 (new: M3)","Experiment 2 (new: M1)")
, palette = "Set1") + 
  theme(axis.title.y=element_blank(), legend.title=element_blank(),
        text = element_text(size=20))
```

## M4 Competition: 2018

\centerline{\includegraphics[width=\paperwidth, height=6.5cm]{figures/m4.png}}

- 100,000 time series: yearly, quarterly, monthly,
weekly, daily, hourly

## \fontsize{15}{15}\bf\sffamily FFORMS: Feature-based FORecast Model Selection

\centerline{\includegraphics[width=\paperwidth, height=\paperheight]{figures/fforms.png}}

## \fontsize{15}{15}\bf\sffamily FFORMS: Feature-based FORecast Model Selection

\centerline{\includegraphics[width=\paperwidth, height=\paperheight]{figures/fformstofforma.png}}

- optimization criterion: classification accuracy

## \fontsize{15}{15}\bf\sffamily FFORMA: Feature-based FORecast Model Averaging

\centerline{\includegraphics[width=\paperwidth, height=\paperheight]{figures/fforma.png}}

- optimization criterion: forecast accuracy

## FFORMA: Models included

- naive 
- random walk with drift 
- seasonal naive 
- theta method 
- automated ARIMA algorithm 
- automated exponential smoothing algorithm 
- TBATS model 
- STLM-AR Seasonal and Trend decomposition using Loess with AR modeling of the seasonally adjusted series 
- neural network time series forecasts 


## \fontsize{15}{15}\bf\sffamily FFORMA: Feature-based FORecast Model Averaging

\begin{itemize}[<+->]

\vfill\item Like FFORMS but we use xgboost rather than a
random forest.

\vfill\item Optimization criterion: forecast accuracy

\vfill\item The probability of each model being best is used
to construct a model weight.

\vfill\item A combination forecast is produced using these
weights.

\vfill\item 248 registrations, 50 submissions

\vfill\item Came second in the M4 competition

\end{itemize}

## \fontsize{12}{12}\bf\sffamily FFORMPP: Feature-based FORecast Model Performance Prediction

\centerline{\includegraphics[width=\paperwidth, height=\paperheight]{figures/fformpp.png}}

\pause

- \fontsize{10}{10}\sffamily use the minimum predicted MASE to select forecast method(s)

## \fontsize{12}{12}\bf\sffamily FFORMPP: Feature-based FORecast Model Performance Prediction

- We use Efficient Bayesian Multivariate Surface Regression
\pause
- **Y:** forecast error of each method, we take the correlation structure between the errors into account.
\pause
- Why Efficient Bayesian Multivariate Surface Regression?
     - handles interactions and nonlinear relationships between features
     - allows the knot locations to move freely in the feature space, thus a less number of knots are usually used
     
## Application to M4 Competition 

- Composition of the time series in the reference set and collection of new time series

\begin{table}[!h]
\centering
\label{observedsample}
\begin{tabular}{l|rrr|r}
\multirow{2}{*}{Frequency} & \multicolumn{3}{c|}{Reference set} &  New series \\ 
                  &   M1    &    M3   &   Simulated   &  M4 \\ \hline
  Yearly          &   181    &   645    &   10000   & 23000 \\
  Quarterly       &   203    &    756   &   10000   &  24000\\
  Monthly         &   617    &    1428   &  10000    &  48000\\
  Weekly          &   -    &   -    &  10000   & 359 \\
  Daily           &   -    &   -    &  10000   & 4227 \\
  Hourly          &   -    &    -   &  10000    & 414\\ \hline
\end{tabular}
\end{table}

## Application to M4 Competition 

- Composition of the time series in the reference set and collection of new time series

\begin{table}[!h]
\centering
\label{observedsample}
\begin{tabular}{l|rrr|r}
\multirow{2}{*}{Frequency} & \multicolumn{3}{c|}{Reference set} &  New series \\ 
                  &   M1    &    M3   &   \colorbox{orange}{Simulated}   &  M4 \\ \hline
  Yearly          &   181    &   645    &   10000   & 23000 \\
  Quarterly       &   203    &    756   &   10000   &  24000\\
  Monthly         &   617    &    1428   &  10000    &  48000\\
  Weekly          &   -    &   -    &  10000   & 359 \\
  Daily           &   -    &   -    &  10000   & 4227 \\
  Hourly          &   -    &    -   &  10000    & 414\\ \hline
\end{tabular}
\end{table}

## Simulated data

- Augmenting the observed sample with simulated time series from mixture
autoregressive (MAR) models

- Proposed by Kang, Hyndman and Li (2018), Efficient generation of time series with diverse and controllable characteristics

- R package: https://github.com/ykang/tsgeneration

## Distribution of time series in the PCA space


```{r pca, dev='png'}

```

- black: observed, green-simulated, orange-M4

## Distribution of time series in the PCA space


```{r pca2, dev='png'}

```

- black: observed, green-simulated, orange-M4

## Results: forecast accuracy based on MASE

\begin{table}[!h]
\centering\scriptsize\tabcolsep=0.12cm
\begin{tabular}{l|rrrrrr}
 & Yearly & Quarterly & Monthly & Weekly & Daily & Hourly \\\hline
\bf{FFORMPP-combination*} & \bf{3.07} &  \bf{1.13}& \bf{0.89} & \bf{2.46} & 3.62 & \bf{0.96} \\
\bf{FFORMPP-individual} & 3.37 &  1.17&  1.05&  2.53& 4.26 &  1.06\\
auto.arima & 3.40 &1.17  &0.93  & 2.55 &  -& - \\
ets & 3.44 &  1.16& 0.95 &  -&-  &  -\\
theta & 3.37 &1.24  & 0.97 &2.64  & 3.33 & 1.59 \\
rwd & \bf{3.07} & 1.33 & 1.18  & 2.68  & 3.25 & 11.45 \\
rw & 3.97 & 1.48 & 1.21  &2.78  & \bf{3.27} & 11.60 \\
nn & 4.06 & 1.55 &  1.14 &4.04 & 3.90 & 1.09 \\
stlar & - & 2.02 &  1.33& 3.15 & 4.49 & 1.49 \\
snaive & - &  1.66& 1.26 &  2.78& 24.46 & 2.86 \\
tbats & - & 1.19 &  1.05& 2.49 & \bf{3.27} &  1.30\\
wn & 13.42 &  6.50&  4.11&  49.91& 38.07 & 11.68 \\
mstlarima & - & - &  - & - & 3.84 &  1.12\\
mstlets & - &  - &  - &  - & 3.73 &  1.23\\
combination (median) & 3.29 & 1.22 &  0.95& 2.57 & 3.52 & 1.33\\
combination (mean) & 4.09 & 1.58 &  1.16&6.96  & 7.94 & 3.93 \\\hline
\end{tabular}
\end{table}

\fontsize{12}{12}\sffamily FFORMPP-combination*: based on median forecasts of the four algorithms with minimum predicted MASE

## Results: FFORMS, FFORMA, FFORMPP

- forecast accuracy based on MASE

\begin{table}[!h]
\centering\footnotesize\tabcolsep=0.12cm
\begin{tabular}{l|rrrrrr}
 & Yearly & Quarterly & Monthly & Weekly & Daily & Hourly \\\hline
FFORMPP-combination* & 3.07 &  1.13& \bf{0.89} & 2.46 & 3.62 & 0.96 \\
FFORMA-combination & \bf{3.06} & \bf{1.11} & \bf{0.89} & \bf{2.10} & \bf{3.34} & \bf{0.81} \\
FFORMPP-individual & 3.37 &  1.17&  1.05&  2.53& 4.26 &  1.06\\
FFORMS-individual & 3.16 &  1.20&  0.98&  2.31& 3.56 &  9.33\\\hline
\end{tabular}
\end{table}



\begin{block}{Algorithm complexity and time to calculate forecasts}
  \centering
FFORMS < FFORMPP < FFORMA
\end{block}

## Discussion and Conclusions

\begin{itemize}[<+->]

\vfill\item Three feature-based algorithms for large scale forecasting.

\vfill\item Each of these algorithms uses a meta-learning approach to guide the way the forecasts are computed.

\vfill\item Future directions: 
 
 - Combination of FFORMS, FFORMA, FFORMPP
 
 - Density forecast

\end{itemize}

## R packages and papers

\fontsize{14}{17}\sf

\begin{block}{R packages}
\begin{itemize}\tightlist
 \item \alert{seer}: FFORMS \newline\url{github.com/thiyangt/seer}
 \item \alert{M4metalearning}: FFORMA. \newline\url{github.com/robjhyndman/M4metalearning}
 \item \alert{fformpp}: FFORMPP \newline\url{github.com/thiyangt/fformpp}
\end{itemize}
\end{block}

\begin{alertblock}{Papers}
Available from \bf{robjhyndman.com}
\end{alertblock}

email: thiyanga.talagala@monash.edu